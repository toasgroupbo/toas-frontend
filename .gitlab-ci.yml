stages:
  - build
  - deploy

default:
  image: node:22-alpine

# Cache optimizado: solo cache de npm
cache:
  key: npm-cache
  paths:
    - .npm/
  policy: pull-push

build_app:
  stage: build

  before_script:
    # Configura npm para usar cache local
    - npm config set cache .npm --global
  script:
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        echo "NEXT_PUBLIC_API_URL=$API_URL_PROD" > .env
        echo "BASEPATH=" >> .env  # O algo como /miapp si aplica
      else
        echo "NEXT_PUBLIC_API_URL=$API_URL_DEV" > .env
        echo "BASEPATH=" >> .env  # Igual puedes dejar vacÃ­o
      fi
    - npm ci
    - npm run build
  artifacts:
    paths:
      - .next/
      - public/
      - .env
      - package.json
      - package-lock.json
      - next.config.js
      - ecosystem.config.js
    expire_in: 1 hour
  tags:
    - docker
    
deploy_to_dev:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh rsync
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan $DEV_HOST >> ~/.ssh/known_hosts
  script:
    - echo "Desplegando al servidor de desarrollo..."
    - rsync -avz --delete .next/ $DEV_USER@$DEV_HOST:$DEV_PATH/.next/
    - rsync -avz --delete public/ $DEV_USER@$DEV_HOST:$DEV_PATH/public/
    - rsync -avz --checksum .env package*.json $DEV_USER@$DEV_HOST:$DEV_PATH/
    - rsync -avz --checksum ecosystem.config.js $DEV_USER@$DEV_HOST:$DEV_PATH/
    - ssh $DEV_USER@$DEV_HOST "
        cd $DEV_PATH &&
        pm2 startOrRestart ecosystem.config.js --env development
      "
  only:
    - development
  tags:
    - docker

deploy_to_prod:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh rsync
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan $PROD_HOST >> ~/.ssh/known_hosts
  script:
    - echo "Desplegando al servidor de produccion..."
    - rsync -avz --delete .next/ $PROD_USER@$PROD_HOST:$PROD_PATH/.next/
    - rsync -avz --delete public/ $PROD_USER@$PROD_HOST:$PROD_PATH/public/
    - rsync -avz --checksum .env package*.json $PROD_USER@$PROD_HOST:$PROD_PATH/
    - rsync -avz --checksum ecosystem.config.js $PROD_USER@$PROD_HOST:$PROD_PATH/
    - ssh $PROD_USER@$PROD_HOST "
        cd $PROD_PATH &&
        pm2 startOrRestart ecosystem.config.js --env production
      "
  only:
    - main
  tags:
    - docker
